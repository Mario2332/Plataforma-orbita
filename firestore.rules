rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Função auxiliar para verificar autenticação
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Função auxiliar para obter dados do usuário
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Função auxiliar para verificar role
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    // Função auxiliar para verificar se é o próprio usuário
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================
    // USERS
    // ============================================
    match /users/{userId} {
      // Qualquer usuário autenticado pode ler documentos de users (necessário para o ranking)
      // Isso permite ver nome e foto de outros alunos no ranking
      allow read: if isAuthenticated();
      
      // Apenas o próprio usuário pode atualizar seus dados básicos
      allow update: if isOwner(userId) && 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'uid']);
      
      // Permitir criação durante cadastro de aluno
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if false;
    }
    
    // ============================================
    // GESTORES
    // ============================================
    match /gestores/{gestorId} {
      allow read: if hasRole('gestor') && isOwner(gestorId);
      allow write: if false; // Apenas via Cloud Functions
    }
    
    // ============================================
    // ESCOLAS
    // ============================================
    match /escolas/{escolaId} {
      // Gestor pode ler todas as escolas
      allow read: if hasRole('gestor');
      
      // Escola pode ler seus próprios dados
      allow read: if hasRole('escola') && isOwner(escolaId);
      
      // Apenas gestor pode criar/atualizar/deletar escolas (via Cloud Functions)
      allow write: if false;
      
      // Anotações da escola sobre alunos
      match /anotacoes/{anotacaoId} {
        allow read, write: if hasRole('escola') && isOwner(escolaId);
      }
    }
    
    // ============================================
    // ALUNOS
    // ============================================
    match /alunos/{alunoId} {
      // Gestor pode ler todos os alunos
      allow read: if hasRole('gestor');
      
      // Escola pode ler alunos vinculados a ela e do mesmo tenant
      allow read: if hasRole('escola') && 
                     get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid &&
                     get(/databases/$(database)/documents/alunos/$(alunoId)).data.tenantId == getUserData().tenantId;
      
      // Aluno pode ler dados de outros alunos do mesmo tenant (necessário para o ranking)
      allow read: if hasRole('aluno') && 
                     get(/databases/$(database)/documents/alunos/$(alunoId)).data.tenantId == getUserData().tenantId;
      
      // Aluno pode atualizar seu perfil (exceto campos críticos)
      allow update: if hasRole('aluno') && 
                       isOwner(alunoId) && 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['userId', 'escolaId', 'tenantId', 'ativo']);
      
      // Permitir criação durante cadastro (usuário autenticado criando seu próprio documento)
      allow create: if isAuthenticated() && request.auth.uid == alunoId;
      
      // Deleção apenas via Cloud Functions
      allow delete: if false;
      
      // ============================================
      // ESTUDOS (subcoleção)
      // ============================================
      match /estudos/{estudoId} {
        // Aluno pode ler, criar, atualizar e deletar seus próprios estudos
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Escola pode ler estudos dos seus alunos
        allow read: if hasRole('escola') && 
                       get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid;
        
        // Gestor pode ler todos os estudos
        allow read: if hasRole('gestor');
      }
      
      // ============================================
      // SIMULADOS (subcoleção)
      // ============================================
      match /simulados/{simuladoId} {
        // Aluno pode ler, criar, atualizar e deletar seus próprios simulados
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Escola pode ler simulados dos seus alunos
        allow read: if hasRole('escola') && 
                       get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid;
        
        // Gestor pode ler todos os simulados
        allow read: if hasRole('gestor');
      }
      
      // ============================================
      // HORÁRIOS (subcoleção)
      // ============================================
      match /horarios/{horarioId} {
        // Aluno pode gerenciar seu cronograma
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Escola pode visualizar cronograma dos seus alunos
        allow read: if hasRole('escola') && 
                       get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid;
      }
      
      // ============================================
      // CONTEÚDOS (subcoleção)
      // ============================================
      match /conteudos/{conteudoId} {
        // Aluno pode gerenciar seu progresso de conteúdos
        allow read, create, update: if hasRole('aluno') && isOwner(alunoId);
        
        // Escola pode visualizar progresso dos seus alunos
        allow read: if hasRole('escola') && 
                       get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid;
      }
      
      // ============================================
      // TEMPLATES (subcoleção)
      // ============================================
      match /templates/{templateId} {
        // Aluno pode gerenciar seus templates de cronograma
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
      }
      
      // ============================================
      // NOTIFICAÇÕES (subcoleção)
      // ============================================
      match /notificacoes/{notificacaoId} {
        // Aluno pode ler, atualizar e deletar suas próprias notificações
        allow read, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Criação apenas via Cloud Functions
        allow create: if false;
      }
      
      // ============================================
      // METAS (subcoleção)
      // ============================================
      match /metas/{metaId} {
        // Aluno pode gerenciar suas próprias metas
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Escola pode visualizar metas dos seus alunos
        allow read: if hasRole('escola') && 
                       get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid;
      }
      
      // ============================================
      // CONTEÚDOS_PROGRESSO (subcoleção)
      // ============================================
      match /conteudos_progresso/{progressoId} {
        // Aluno pode gerenciar seu progresso de conteúdos
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Escola pode visualizar progresso dos seus alunos
        allow read: if hasRole('escola') && 
                       get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid;
      }
      
      // ============================================
      // PLANOS DE AÇÃO (subcoleção)
      // ============================================
      match /planosAcao/{planoId} {
        // Aluno pode gerenciar seus próprios planos de ação
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Escola pode visualizar planos de ação dos seus alunos
        allow read: if hasRole('escola') && 
                       get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid;
      }
      
      // ============================================
      // DIAGNÓSTICO DE PERFIL (subcoleção)
      // ============================================
      match /diagnostico/{diagnosticoId} {
        // Aluno pode gerenciar seu próprio diagnóstico de perfil
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Escola pode visualizar diagnóstico de perfil dos seus alunos
        allow read: if hasRole('escola') && 
                       get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid;
      }
      
      // ============================================
      // AUTODIAGNÓSTICOS (subcoleção)
      // ============================================
      match /autodiagnosticos/{autodiagnosticoId} {
        // Aluno pode gerenciar seus próprios autodiagnósticos
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Escola pode visualizar autodiagnósticos dos seus alunos
        allow read: if hasRole('escola') && 
                       get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid;
      }
      
      // ============================================
      // REDAÇÕES (subcoleção)
      // ============================================
      match /redacoes/{redacaoId} {
        // Aluno pode gerenciar suas próprias redações
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Escola pode visualizar redações dos seus alunos
        allow read: if hasRole('escola') && 
                       get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid;
      }
      
      // ============================================
      // CONFIGURAÇÕES (subcoleção)
      // ============================================
      match /configuracoes/{configId} {
        // Aluno pode gerenciar suas próprias configurações
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Escola pode visualizar configurações dos seus alunos
        allow read: if hasRole('escola') && 
                       get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid;
      }
      
      // ============================================
      // DIÁRIO EMOCIONAL (subcoleção)
      // ============================================
      match /diario_emocional/{diarioId} {
        // Aluno pode gerenciar seu próprio diário emocional
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Escola pode visualizar diário emocional dos seus alunos
        allow read: if hasRole('escola') && 
                       get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid;
      }
      
      // ============================================
      // CRONOGRAMA DINÂMICO (subcoleção)
      // ============================================
      match /cronograma/{cronogramaId} {
        // Aluno pode gerenciar seu próprio cronograma dinâmico
        allow read, create, update, delete: if hasRole('aluno') && isOwner(alunoId);
        
        // Escola pode visualizar cronograma dos seus alunos
        allow read: if hasRole('escola') && 
                       get(/databases/$(database)/documents/alunos/$(alunoId)).data.escolaId == request.auth.uid;
      }
    }
    
    // ============================================
    // RANKING (coleção principal)
    // ============================================
    match /ranking/{rankingId} {
      // Qualquer usuário autenticado pode ler o ranking (para ver todos os alunos)
      allow read: if isAuthenticated();
      
      // Aluno pode atualizar apenas seu próprio registro de ranking
      allow update: if hasRole('aluno') && isOwner(rankingId);
      
      // Criação e deleção apenas via Cloud Functions
      allow create, delete: if false;
    }
    
    // ============================================
    // RANKING HISTÓRICO (coleção principal)
    // ============================================
    match /ranking_historico/{historicoId} {
      // Qualquer usuário autenticado pode ler o histórico
      allow read: if isAuthenticated();
      
      // Escrita apenas via Cloud Functions
      allow write: if false;
    }
    
    // ============================================
    // CONFIGURAÇÃO DO DIAGNÓSTICO DE PERFIL (coleção principal)
    // ============================================
    match /diagnostico_perfil_config/{configId} {
      // Qualquer usuário autenticado pode ler a configuração
      allow read: if isAuthenticated();
      
      // Apenas escolaes podem escrever
      allow write: if hasRole('escola');
    }
    
    // ============================================
    // MENSAGENS DE CONTATO (coleção principal)
    // ============================================
    match /mensagens_contato/{mensagemId} {
      // Qualquer pessoa pode criar uma mensagem (formulário público)
      allow create: if true;
      
      // Apenas gestores podem ler e atualizar mensagens
      allow read, update: if hasRole('gestor');
      
      // Apenas gestores podem deletar mensagens
      allow delete: if hasRole('gestor');
    }
    
    // ============================================
    // TENANTS / CLIENTES WHITE-LABEL (coleção principal)
    // ============================================
    match /tenants/{tenantId} {
      // Qualquer pessoa pode ler (para carregar configurações do tenant pelo domínio)
      allow read: if true;
      
      // Gestores autenticados podem criar, atualizar e deletar tenants
      // Nota: Não verificamos role aqui porque o gestor está autenticado via outro projeto (orbita-free)
      // e o documento /users/{userId} não existe no plataforma-orbita
      allow create, update, delete: if isAuthenticated();
    }
  }
}
